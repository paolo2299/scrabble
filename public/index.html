<!-- index.html -->
<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Scrabble</title>
    <script src="vendor/react.js"></script>
    <script src="vendor/react-dom.js"></script>
    <script src="vendor/babel.js"></script>
    <script src="vendor/jquery-3.1.1.min.js"></script>
    <script src="vendor/lodash.min.js"></script>
    <link rel="stylesheet" type="text/css" href="style.css">
  </head>
  <body>
    <div id="content"></div>
    <script type="text/babel">
      var Util = {
        findByAttribute: function(collection, attribute, value) {
          return _.find(
            collection,
            function(x){ return _.isEqual(x[attribute], value); }
          );
        }
      }

      var GameContainer = React.createClass({
        findByPosition(tiles, position) {
          return Util.findByAttribute(tiles, 'position', position)
        },

        getInitialState: function() {
          var initialState = {
            playedTiles: [
              {tileId: 100, letter: "B", score: 2, position: [1, 1]},
              {tileId: 101, letter: "A", score: 1, position: [1, 2]},
              {tileId: 103, letter: "T", score: 1, position: [1, 3]}
            ],

            playerTiles: [
              {tileId: 1, letter: "A", score: 1},
              {tileId: 2, letter: "C", score: 2},
              {tileId: 3, letter: "T", score: 1},
              {tileId: 4, letter: "A", score: 1},
              {tileId: 5, letter: "A", score: 1}
            ],

            selectedTileId: null,

            tentativelyPlayedTiles: []
          };
          return initialState;
        },

        handleTileRackTileClicked: function(tileId) {
          if (_.find(this.state.tentativelyPlayedTiles, { tileId: tileId })) {
            return;
          }
          this.setState({selectedTileId: tileId});
        },

        handleBoardCellClicked: function(colIndex, rowIndex) {
          let allTiles = this.state.tentativelyPlayedTiles + this.state.playedTiles;
          if (this.findByPosition(allTiles, [colIndex, rowIndex])) {
            return;
          }
          if (!this.state.selectedTileId) {
            return;
          }
          let selectedTile = _.find(this.state.playerTiles, {tileId: this.state.selectedTileId});
          selectedTile.position = [colIndex, rowIndex];
          this.setState({tentativelyPlayedTiles: this.state.tentativelyPlayedTiles.concat([selectedTile])});
          this.setState({selectedTileId: null});
        },

        reset: function() {
          this.setState({tentativelyPlayedTiles: []});
          this.setState({selectedTileId: null});
        },

        render: function() {
          return (
            <div className="GameContainer">
              <Board
                playedTiles={this.state.playedTiles}
                playerTiles={this.state.playerTiles}
                tentativelyPlayedTiles={this.state.tentativelyPlayedTiles}
                onBoardCellClicked={this.handleBoardCellClicked}
              />
              <TileRack
                selectedTileId={this.state.selectedTileId}
                playerTiles={this.state.playerTiles}
                tentativelyPlayedTiles={this.state.tentativelyPlayedTiles}
                onTileClicked={this.handleTileRackTileClicked}
              />
              <ResetButton onClick={this.reset}>
                reset
              </ResetButton>
            </div>
          );
        }
      });

      var Board = React.createClass({
        findByPosition(tiles, position) {
          return Util.findByAttribute(tiles, 'position', position)
        },

        doNothing: function() {
          return;
        },

        findPlayedTile: function(colIndex, rowIndex) {
          var tile = null;
          var tileData = this.findByPosition(this.props.playedTiles, [colIndex, rowIndex]);
          if (tileData) {
            tile = <Tile
              key={tileData.tileId}
              letter={tileData.letter}
              score={tileData.score}
              onTileClicked={this.doNothing}
            />;
          }
          return tile;
        },

        findTentativelyPlayedTile: function(colIndex, rowIndex) {
          var tile = null;
          var tileData = null;
          var tileId = null;
          var tileIndexData = this.findByPosition(this.props.tentativelyPlayedTiles, [colIndex, rowIndex]);
          if (tileIndexData) {
            tileId = tileIndexData.tileId;
            tileData = _.find(this.props.playerTiles, { 'tileId': tileId });
            tile = <Tile
              letter={tileData.letter}
              score={tileData.score}
              tentative={true}
              onTileClicked={this.doNothing}
            />;
          }
          return tile;
        },

        handleCellClick: function(colIndex, rowIndex) {
          this.props.onBoardCellClicked(colIndex, rowIndex);
        },

        render: function() {
          var self = this;
          var boardRows = _.range(15).map(function(rowIndex){
            var squares = _.range(15).map(function(colIndex){
              var square;
              var tile = self.findPlayedTile(colIndex, rowIndex) ||
                         self.findTentativelyPlayedTile(colIndex, rowIndex);
              return (
                <BoardCell key={colIndex} colIndex={colIndex} rowIndex={rowIndex} onCellClicked={self.handleCellClick}>
                  { tile }
                </BoardCell>
              );
              return square;
            });
            return (
              <tr className="BoardRow" key={rowIndex}>
                { squares }
              </tr>
            );
          });
          return (
            <table className="Board">
              <tbody>
                { boardRows }
              </tbody>
            </table>
          )
        }
      });

      var BoardCell = React.createClass({
        handleClick: function() {
          this.props.onCellClicked(this.props.colIndex, this.props.rowIndex);
        },

        render: function() {
          return (
            <td className="BoardCell" onClick={this.handleClick}>
              { this.props.children }
            </td>
          )
        }
      });

      var TileRack = React.createClass({
        onTileClicked: function(tileId) {
          this.props.onTileClicked(tileId);
        },

        render: function() {
          let self = this;
          var tiles = this.props.playerTiles.map(function(tile) {
            let selected = false;
            if (tile.tileId === self.props.selectedTileId) {
              selected = true;
            }
            let tentative = false;
            if (_.find(self.props.tentativelyPlayedTiles, { tileId: tile.tileId })) {
              tentative = true;
            }
            return (
              <Tile
                key={tile.tileId}
                tileId={tile.tileId}
                letter={tile.letter}
                score={tile.score}
                selected={selected}
                tentative={tentative}
                onTileClicked={self.onTileClicked}
              />
            );
          });
          return (
            <div className="TileRack">
              { tiles }
            </div>
          )
        }
      });

      var Tile = React.createClass({
        handleClick: function(e) {
          this.props.onTileClicked(this.props.tileId);
        },

        render: function() {
          let className = "Tile";
          if (this.props.tentative) {
            className += " tentative";
          }
          if (this.props.selected) {
            className += " selected";
          }
          return (
            <div className={className} onClick={this.handleClick}>
              <span className="Letter">
                {this.props.letter}
              </span><span className="Score">
                {this.props.score}
              </span>
            </div>
          )
        }
      });

      var ResetButton = React.createClass({
        handleClick: function() {
          this.props.onClick();
        },

        render: function() {
          return (
            <button className="ResetButton" onClick={this.handleClick}>
              Reset Tiles
            </button>
          )
        }
      });

      ReactDOM.render(
        <GameContainer />,
        document.getElementById('content')
      );
    </script>
  </body>
</html>
