<!-- index.html -->
<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Scrabble</title>
    <script src="vendor/react.js"></script>
    <script src="vendor/react-dom.js"></script>
    <script src="vendor/babel.js"></script>
    <script src="vendor/jquery-3.1.1.min.js"></script>
    <script src="vendor/lodash.min.js"></script>
    <link rel="stylesheet" type="text/css" href="style.css">
  </head>
  <body>
    <div id="content"></div>
    <script type="text/babel">
      var Util = {
        findByAttribute: function(collection, attribute, value) {
          return _.find(
            collection,
            function(x){ return _.isEqual(x[attribute], value); }
          );
        }
      }

      var GameContainer = React.createClass({
        componentDidMount: function() {
          let self = this;
          $.post("/games", {}, function(response){
            console.log("POST GAMES RESPONSE");
            console.log(response);
            self.setState({
              gameId: response.id,
              playedTiles: response.board.playedTiles,
              playerTiles: response.player.tiles,
              selectedTileId: null,
              tentativelyPlayedTiles: []
            });
          });
        },

        findByPosition: function(tiles, position) {
          return Util.findByAttribute(tiles, 'position', position)
        },

        getInitialState: function() {
          var initialState = {
            playedTiles: [],
            playerTiles: [],
            selectedTileId: null,
            tentativelyPlayedTiles: []
          };
          return initialState;
        },

        handleTileRackTileClicked: function(tileId) {
          if (_.find(this.state.tentativelyPlayedTiles, { id: tileId })) {
            return;
          }
          this.setState({selectedTileId: tileId});
        },

        handleBoardCellClicked: function(colIndex, rowIndex) {
          let allTiles = this.state.tentativelyPlayedTiles + this.state.playedTiles;
          if (this.findByPosition(allTiles, [colIndex, rowIndex])) {
            return;
          }
          if (!this.state.selectedTileId) {
            return;
          }
          let selectedTile = _.find(this.state.playerTiles, {id: this.state.selectedTileId});
          selectedTile.position = [colIndex, rowIndex];
          this.setState({tentativelyPlayedTiles: this.state.tentativelyPlayedTiles.concat([selectedTile])});
          this.setState({selectedTileId: null});
        },

        reset: function() {
          this.setState({tentativelyPlayedTiles: []});
          this.setState({selectedTileId: null});
        },

        playTiles: function() {
          console.log("tentativelyPlayedTiles");
          console.log(this.state.tentativelyPlayedTiles);
          let self = this;
          let postData = {
            playedTiles: this.state.tentativelyPlayedTiles
          };
          console.log(JSON.stringify(postData));
          $.ajax({
            url: '/games/' + this.state.gameId + '/play',
            method: 'POST',
            data: JSON.stringify(postData),
            contentType:'application/json; charset=utf-8',
            dataType: 'json',
            success: function(data) {
              console.log("GOT DATA");
              console.log(data);
              self.setState({
                playedTiles: data.board.playedTiles,
                playerTiles: data.player.tiles,
                selectedTileId: null,
                tentativelyPlayedTiles: []
              });
            }
          });
        },

        render: function() {
          return (
            <div className="GameContainer">
              <Board
                playedTiles={this.state.playedTiles}
                playerTiles={this.state.playerTiles}
                tentativelyPlayedTiles={this.state.tentativelyPlayedTiles}
                onBoardCellClicked={this.handleBoardCellClicked}
              />
              <TileRack
                selectedTileId={this.state.selectedTileId}
                playerTiles={this.state.playerTiles}
                tentativelyPlayedTiles={this.state.tentativelyPlayedTiles}
                onTileClicked={this.handleTileRackTileClicked}
              />
              <ResetButton onClick={this.reset}>
                reset
              </ResetButton>
              <PlayTilesButton onClick={this.playTiles}>
                play
              </PlayTilesButton>
            </div>
          );
        }
      });

      var Board = React.createClass({
        findByPosition(tiles, position) {
          return Util.findByAttribute(tiles, 'position', position)
        },

        doNothing: function() {
          return;
        },

        findPlayedTile: function(colIndex, rowIndex) {
          var tile = null;
          var tileData = this.findByPosition(this.props.playedTiles, [colIndex, rowIndex]);
          if (tileData) {
            tile = <Tile
              key={tileData.id}
              letter={tileData.letter}
              score={tileData.score}
              onTileClicked={this.doNothing}
            />;
          }
          return tile;
        },

        findTentativelyPlayedTile: function(colIndex, rowIndex) {
          var tile = null;
          var tileData = null;
          var tileId = null;
          var tileIndexData = this.findByPosition(this.props.tentativelyPlayedTiles, [colIndex, rowIndex]);
          if (tileIndexData) {
            tileId = tileIndexData.id;
            tileData = _.find(this.props.playerTiles, { 'id': tileId });
            tile = <Tile
              letter={tileData.letter}
              score={tileData.score}
              tentative={true}
              onTileClicked={this.doNothing}
            />;
          }
          return tile;
        },

        handleCellClick: function(colIndex, rowIndex) {
          this.props.onBoardCellClicked(colIndex, rowIndex);
        },

        render: function() {
          var self = this;
          var boardRows = _.range(15).map(function(rowIndex){
            var squares = _.range(15).map(function(colIndex){
              var square;
              var tile = self.findPlayedTile(colIndex, rowIndex) ||
                         self.findTentativelyPlayedTile(colIndex, rowIndex);
              return (
                <BoardCell key={colIndex} colIndex={colIndex} rowIndex={rowIndex} onCellClicked={self.handleCellClick}>
                  { tile }
                </BoardCell>
              );
              return square;
            });
            return (
              <tr className="BoardRow" key={rowIndex}>
                { squares }
              </tr>
            );
          });
          return (
            <table className="Board">
              <tbody>
                { boardRows }
              </tbody>
            </table>
          )
        }
      });

      var BoardCell = React.createClass({
        handleClick: function() {
          this.props.onCellClicked(this.props.colIndex, this.props.rowIndex);
        },

        render: function() {
          return (
            <td className="BoardCell" onClick={this.handleClick}>
              { this.props.children }
            </td>
          )
        }
      });

      var TileRack = React.createClass({
        onTileClicked: function(tileId) {
          this.props.onTileClicked(tileId);
        },

        render: function() {
          let self = this;
          var tiles = this.props.playerTiles.map(function(tile) {
            if (!tile) {
              //TODO actually render something so that the TileRack can be correct size
              return null;
            }
            let selected = false;
            if (tile.id === self.props.selectedTileId) {
              selected = true;
            }
            let tentative = false;
            if (_.find(self.props.tentativelyPlayedTiles, { id: tile.id })) {
              tentative = true;
            }
            return (
              <Tile
                key={tile.id}
                tileId={tile.id}
                letter={tile.letter}
                score={tile.score}
                selected={selected}
                tentative={tentative}
                onTileClicked={self.onTileClicked}
              />
            );
          });
          return (
            <div className="TileRack">
              { tiles }
            </div>
          )
        }
      });

      var Tile = React.createClass({
        handleClick: function(e) {
          this.props.onTileClicked(this.props.tileId);
        },

        render: function() {
          let className = "Tile";
          if (this.props.tentative) {
            className += " tentative";
          }
          if (this.props.selected) {
            className += " selected";
          }
          return (
            <div className={className} onClick={this.handleClick}>
              <span className="Letter">
                {this.props.letter}
              </span><span className="Score">
                {this.props.score}
              </span>
            </div>
          )
        }
      });

      var ResetButton = React.createClass({
        handleClick: function() {
          this.props.onClick();
        },

        render: function() {
          return (
            <button className="ResetButton" onClick={this.handleClick}>
              Reset Tiles
            </button>
          )
        }
      });

      var PlayTilesButton = React.createClass({
        handleClick: function() {
          this.props.onClick();
        },

        render: function() {
          return (
            <button className="PlayTilesButton" onClick={this.handleClick}>
              Play
            </button>
          )
        }
      });

      ReactDOM.render(
        <GameContainer />,
        document.getElementById('content')
      );
    </script>
  </body>
</html>
